{"ast":null,"code":"import React from \"react\";\nvar __jsx = React.createElement;\nimport { useRef, useState, createContext, useContext, useEffect } from 'react';\nimport { useLazyQuery, useMutation } from '@apollo/client';\nimport Router from 'next/router';\nimport Cookies from 'js-cookie';\nimport { COMPANY_NAME } from 'utils/config';\nimport { LOGOUT_USER, GET_ME } from 'apis/User';\nimport { DELETE_MESSAGE, DELETE_REPLY_MESSAGE } from 'apis/Message';\nimport { AppContext } from './AppContext';\nconst UserContext = createContext();\nconst UserProvider = ({\n  children\n}) => {\n  const {\n    0: user,\n    1: setUser\n  } = useState(null);\n  const {\n    0: messageQueue,\n    1: setMessageQueue\n  } = useState([]);\n  const messageQueueRef = useRef(messageQueue);\n  messageQueueRef.current = messageQueue;\n  const [logoutUser] = useMutation(LOGOUT_USER);\n  const [fetchMe, {\n    data: {\n      me,\n      loading\n    } = {}\n  }] = useLazyQuery(GET_ME, {\n    fetchPolicy: 'network-only',\n    onCompleted: () => {\n      localStorage.setItem('tenant', COMPANY_NAME());\n      setUser(me);\n      Router.push(`/[company]/[community]/[channel]`, `/${COMPANY_NAME()}/general/general`, {\n        shallow: true\n      });\n    }\n  });\n  const {\n    userLoaded,\n    setUserLoaded\n  } = useContext(AppContext);\n  const [deleteMessageMutation] = useMutation(DELETE_MESSAGE);\n  const [deleteReplyMessage] = useMutation(DELETE_REPLY_MESSAGE);\n  const [fetchOnly, {\n    data: {\n      me: me1\n    } = {}\n  }] = useLazyQuery(GET_ME, {\n    fetchPolicy: 'network-only',\n    onCompleted: () => {\n      localStorage.setItem('tenant', COMPANY_NAME());\n      setUser(me1);\n      if (!userLoaded) {\n        setUserLoaded(true);\n      }\n    }\n  });\n  const logout = async () => {\n    try {\n      await logoutUser({});\n    } catch (error) {\n      alert(error);\n    }\n    Cookies.remove('token');\n    setUser(null);\n    if (window) {\n      window.localStorage.setItem('logout', Date.now());\n      localStorage.removeItem('user');\n    }\n  };\n  const signin = token => {\n    Cookies.set('token', token, {\n      expires: 30\n    });\n    fetchMe();\n  };\n  const getMe = () => {\n    fetchOnly();\n  };\n  useEffect(() => {\n    if (!user) {\n      getMe();\n    }\n  }, []);\n  useEffect(() => {\n    if (user === null) {\n      const localState = JSON.parse(localStorage.getItem('user'));\n      if (localState) {\n        setUser(localState);\n      }\n    } else if (localStorage.getItem('tenant') !== COMPANY_NAME()) {\n      logout();\n    } else {\n      localStorage.setItem('user', JSON.stringify(user));\n    }\n  }, [user]);\n  useEffect(() => {\n    if (messageQueue.length > 0) {\n      setTimeout(deleteMessage, 5000);\n    }\n  }, [messageQueue]);\n  const addMessageQueue = messageId => {\n    if (messageQueueRef.current.indexOf(messageId) === -1) {\n      setMessageQueue([...messageQueueRef.current, messageId]);\n    }\n  };\n  const removeMessageQueue = messageId => {\n    const data = messageQueueRef.current.filter(e => e !== messageId);\n    setMessageQueue(data);\n  };\n  const deleteMessage = () => {\n    const messageId = messageQueueRef.current.shift();\n    if (messageId) {\n      setMessageQueue(messageQueueRef.current);\n      deleteMessageMutation({\n        variables: {\n          messageId\n        }\n      });\n      deleteReplyMessage({\n        variables: {\n          messageId\n        }\n      });\n    }\n  };\n  const getMessageQueue = () => {\n    return messageQueueRef.current;\n  };\n  return __jsx(UserContext.Provider, {\n    value: {\n      isLogged: !!user,\n      user,\n      setUser,\n      getMe,\n      signin,\n      logout,\n      loading,\n      addMessageQueue,\n      removeMessageQueue,\n      getMessageQueue\n    }\n  }, children);\n};\nexport { UserProvider as default, UserContext };","map":{"version":3,"names":["useRef","useState","createContext","useContext","useEffect","useLazyQuery","useMutation","Router","Cookies","COMPANY_NAME","LOGOUT_USER","GET_ME","DELETE_MESSAGE","DELETE_REPLY_MESSAGE","AppContext","UserContext","UserProvider","children","user","setUser","messageQueue","setMessageQueue","messageQueueRef","current","logoutUser","fetchMe","data","me","loading","fetchPolicy","onCompleted","localStorage","setItem","push","shallow","userLoaded","setUserLoaded","deleteMessageMutation","deleteReplyMessage","fetchOnly","me1","logout","error","alert","remove","window","Date","now","removeItem","signin","token","set","expires","getMe","localState","JSON","parse","getItem","stringify","length","setTimeout","deleteMessage","addMessageQueue","messageId","indexOf","removeMessageQueue","filter","e","shift","variables","getMessageQueue","isLogged","default"],"sources":["/Volumes/MacData/work/ciscord-frontend.git/context/UserContext.js"],"sourcesContent":["import { useRef, useState, createContext, useContext, useEffect } from 'react';\nimport { useLazyQuery, useMutation } from '@apollo/client';\nimport Router from 'next/router';\nimport Cookies from 'js-cookie';\nimport { COMPANY_NAME } from 'utils/config';\nimport { LOGOUT_USER, GET_ME } from 'apis/User';\nimport { DELETE_MESSAGE, DELETE_REPLY_MESSAGE } from 'apis/Message';\nimport { AppContext } from './AppContext';\n\nconst UserContext = createContext();\n\nconst UserProvider = ({ children }) => {\n  const [user, setUser] = useState(null);\n  const [messageQueue, setMessageQueue] = useState([]);\n  const messageQueueRef = useRef(messageQueue);\n  messageQueueRef.current = messageQueue;\n\n  const [logoutUser] = useMutation(LOGOUT_USER);\n  const [fetchMe, { data: { me, loading } = {} }] = useLazyQuery(GET_ME, {\n    fetchPolicy: 'network-only',\n    onCompleted: () => {\n      localStorage.setItem('tenant', COMPANY_NAME());\n      setUser(me);\n      Router.push(`/[company]/[community]/[channel]`, `/${COMPANY_NAME()}/general/general`, {\n        shallow: true,\n      });\n    },\n  });\n\n  const { userLoaded, setUserLoaded } = useContext(AppContext);\n  const [deleteMessageMutation] = useMutation(DELETE_MESSAGE);\n  const [deleteReplyMessage] = useMutation(DELETE_REPLY_MESSAGE);\n\n  const [fetchOnly, { data: { me: me1 } = {} }] = useLazyQuery(GET_ME, {\n    fetchPolicy: 'network-only',\n    onCompleted: () => {\n      localStorage.setItem('tenant', COMPANY_NAME());\n      setUser(me1);\n      if (!userLoaded) {\n        setUserLoaded(true);\n      }\n    },\n  });\n\n  const logout = async () => {\n    try {\n      await logoutUser({});\n    } catch (error) {\n      alert(error);\n    }\n\n    Cookies.remove('token');\n    setUser(null);\n    if (window) {\n      window.localStorage.setItem('logout', Date.now());\n      localStorage.removeItem('user');\n    }\n  };\n\n  const signin = token => {\n    Cookies.set('token', token, { expires: 30 });\n    fetchMe();\n  };\n\n  const getMe = () => {\n    fetchOnly();\n  };\n\n  useEffect(() => {\n    if (!user) {\n      getMe();\n    }\n  }, []);\n\n  useEffect(() => {\n    if (user === null) {\n      const localState = JSON.parse(localStorage.getItem('user'));\n      if (localState) {\n        setUser(localState);\n      }\n    } else if (localStorage.getItem('tenant') !== COMPANY_NAME()) {\n      logout();\n    } else {\n      localStorage.setItem('user', JSON.stringify(user));\n    }\n  }, [user]);\n\n  useEffect(() => {\n    if (messageQueue.length > 0) {\n      setTimeout(deleteMessage, 5000);\n    }\n  }, [messageQueue]);\n\n  const addMessageQueue = messageId => {\n    if (messageQueueRef.current.indexOf(messageId) === -1) {\n      setMessageQueue([...messageQueueRef.current, messageId]);\n    }\n  };\n\n  const removeMessageQueue = messageId => {\n    const data = messageQueueRef.current.filter(e => e !== messageId);\n\n    setMessageQueue(data);\n  };\n\n  const deleteMessage = () => {\n    const messageId = messageQueueRef.current.shift();\n    if (messageId) {\n      setMessageQueue(messageQueueRef.current);\n      deleteMessageMutation({ variables: { messageId } });\n      deleteReplyMessage({\n        variables: {\n          messageId,\n        },\n      });\n    }\n  };\n\n  const getMessageQueue = () => {\n    return messageQueueRef.current;\n  };\n  return (\n    <UserContext.Provider\n      value={{\n        isLogged: !!user,\n        user,\n        setUser,\n        getMe,\n        signin,\n        logout,\n        loading,\n        addMessageQueue,\n        removeMessageQueue,\n        getMessageQueue,\n      }}\n    >\n      {children}\n    </UserContext.Provider>\n  );\n};\n\nexport { UserProvider as default, UserContext };\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}